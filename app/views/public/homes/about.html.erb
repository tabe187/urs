<h2>gmap</h2>

<!-- 地名入力用のinputを追加 -->
<input id="address" type="textbox" value="Sydney, NSW">

<!-- buttonをクリックしたらcodeAddressを実行　-->
<input type="button" value="Encode" onclick="codeAddress()">
<div id='map'>
</div>

<style>
#map{
  height: 400px;
}
</style>

<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAP_API_KEY'] %>&callback=initMap&libraries=places" async defer></script>

<script>
let map
let geocoder

function initMap(){
  let marker = [];
  let infoWindow = [];
  let latlng;
  const maps = gon.maps;
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 35.658, lng: 139.701},
    zoom: 15
  });

  for (let i = 0; i < maps.length; i++) {
    latlng = new google.maps.LatLng(maps[i].latitude, maps[i].longitude);
    marker[i] = new google.maps.Marker({
            map: map,
            position: latlng,
      });

      infoWindow[i] = new google.maps.InfoWindow({
                // contentで中身を指定
                // 今回は文字にリンクを貼り付けた形で表示
                content: `<a href='/maps/${maps[i].id}'>${maps[i].place_name}</a>`
                });
                // markerがクリックされた時、
                marker[i].addListener("click", function(){
                    // infoWindowを表示
                    infoWindow[i].open(map, marker[i]);
                });
    }
}


function codeAddress(){
  let inputAddress = document.getElementById('address').value;
  geocoder = new google.maps.Geocoder()
  geocoder.geocode( { 'address': inputAddress},

  function(results, status) {
    if (status == 'OK') {
      map.setCenter(results[0].geometry.location);

    } else {
      alert('Geocode was not successful for the following reason: ' + status);
    }
  });
}
</script>
